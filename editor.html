<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Portfolio Editor</title>
<style>
  :root{--bg:#0b1020;--surface:#0f172a;--card:#0b1224;--line:#1e293b;--text:#e2e8f0;--muted:#9aa6b2;--brand:#7c3aed;--r:14px}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
  .container{max-width:1100px;margin:0 auto;padding:16px}
  header{position:sticky;top:0;background:#0b1020cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line);z-index:20}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  @media (max-width:800px){.row{grid-template-columns:1fr}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);padding:14px}
  input,textarea{width:100%;padding:10px;border-radius:10px;border:1px solid var(--line);background:var(--surface);color:var(--text)}
  textarea{min-height:90px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .btn{display:inline-flex;align-items:center;gap:8px;background:var(--brand);border:1px solid #6d28d9;color:#fff;padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn.secondary{background:transparent;color:var(--text)}
  .list{display:flex;flex-direction:column;gap:10px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .small{color:var(--muted);font-size:12px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="container toolbar">
    <strong>Portfolio — Editor</strong>
    <button class="btn" id="loadJson">Load data.json</button>
    <button class="btn" id="saveDraft">Save draft (device)</button>
    <button class="btn" id="publish">Publish to GitHub</button>
    <span id="status" class="small"></span>
  </div>
</header>

<main class="container" style="padding:14px 16px 40px">
  <!-- Site / Hero -->
  <section class="card">
    <h3>Site / Hero</h3>
    <div class="row">
      <div><label>Site title / Name<input id="site_title" placeholder="Sreeja Loho Choudhury"/></label></div>
      <div><label>Résumé URL (optional)<input id="resume_url" placeholder="/resume.pdf"/></label></div>
    </div>
    <div class="row">
      <div><label>Hero lead/intro<textarea id="hero_lead" placeholder="Short introduction"></textarea></label></div>
      <div><label>Location line<textarea id="hero_location" placeholder="Based in … • Timezone …"></textarea></label></div>
    </div>
    <div class="row" style="align-items:end">
      <div><label>Hero image URL<input id="hero_img" placeholder="assets/portrait.jpg"/></label></div>
      <div>
        <label>Upload hero image<input type="file" id="hero_img_upload" accept="image/*"/></label>
        <div class="small">Click “OK” to set it</div>
        <button class="btn secondary" id="hero_img_ok">OK</button>
      </div>
    </div>
  </section>

  <!-- About -->
  <section class="card">
    <h3>About</h3>
    <label>About text<textarea id="about_text"></textarea></label>
  </section>

  <!-- Research items -->
  <section class="card">
    <div class="toolbar" style="justify-content:space-between">
      <h3 style="margin:0">Research items</h3>
      <button class="btn" id="addResearch">+ Add item</button>
    </div>
    <div id="researchList" class="list"></div>
  </section>

  <!-- Publications -->
  <section class="card">
    <div class="toolbar" style="justify-content:space-between">
      <h3 style="margin:0">Publications</h3>
      <button class="btn" id="addPub">+ Add publication</button>
    </div>
    <div id="pubList" class="list"></div>
  </section>

  <!-- Skills -->
  <section class="card">
    <div class="toolbar" style="justify-content:space-between">
      <h3 style="margin:0">Skills (three cards)</h3>
      <button class="btn" id="addSkill">+ Add skill card</button>
    </div>
    <div id="skillList" class="list"></div>
  </section>

  <!-- Contact -->
  <section class="card">
    <h3>Contact</h3>
    <div class="row">
      <div><label>Email<input id="contact_email" placeholder="you@example.com"/></label></div>
      <div><label>Location<input id="contact_location" placeholder="City, Country"/></label></div>
    </div>
    <div class="row">
      <div><label>Socials (comma-separated, e.g. https://github.com/..., https://linkedin.com/in/...)<textarea id="contact_socials"></textarea></label></div>
      <div class="small">Add as many as you like</div>
    </div>
  </section>

  <!-- GitHub settings -->
  <section class="card">
    <h3>GitHub publish</h3>
    <div class="row">
      <div><label>Repo (owner/name)<input id="repo" placeholder="owner/repo"/></label></div>
      <div><label>Branch<input id="branch" placeholder="main"/></label></div>
    </div>
    <div class="row">
      <div><label>Site folder (optional)<input id="rootPath" placeholder=""/></label></div>
      <div><label>Fine-grained PAT (contents:write)<input id="token" type="password" placeholder="github_pat_..."/></label></div>
    </div>
    <div class="toolbar">
      <button class="btn" id="remember">Remember</button>
      <button class="btn secondary" id="forget">Forget</button>
    </div>
  </section>
</main>

<script>
const $ = s=>document.querySelector(s);
const state = {
  site:{ title:'Sreeja Loho Choudhury', resume:'', hero:{lead:'', img:'', location:''}},
  about:{ text:''},
  research:[], // {title,desc,img,tags[]}
  publications:[], // {title,meta,link}
  skills:[], // {title,text}
  contact:{ email:'', location:'', socials:[]},
  _uploads:{} // path -> File
};
const els = {
  site_title:$('#site_title'), resume_url:$('#resume_url'),
  hero_lead:$('#hero_lead'), hero_img:$('#hero_img'), hero_img_upload:$('#hero_img_upload'),
  hero_img_ok:$('#hero_img_ok'), hero_location:$('#hero_location'),
  about_text:$('#about_text'),
  researchList:$('#researchList'), addResearch:$('#addResearch'),
  pubList:$('#pubList'), addPub:$('#addPub'),
  skillList:$('#skillList'), addSkill:$('#addSkill'),
  contact_email:$('#contact_email'), contact_location:$('#contact_location'), contact_socials:$('#contact_socials'),
  repo:$('#repo'), branch:$('#branch'), rootPath:$('#rootPath'), token:$('#token'),
  status:$('#status')
};
function fileSafe(n){return n.toLowerCase().replace(/[^a-z0-9._-]+/g,'-').replace(/^-+|-+$/g,'');}
function setStatus(t){els.status.textContent=t||'';}
function unique(a){return Array.from(new Set(a));}

function render(){
  // simple render lists
  els.researchList.innerHTML='';
  state.research.forEach((it,idx)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class="grid">
        <div><label>Title<input data-k="title" value="${it.title||''}"/></label></div>
        <div><label>Image URL<input data-k="img" value="${it.img||''}" placeholder="assets/proj-1.jpg"/></label></div>
      </div>
      <label>Description<textarea data-k="desc">${it.desc||''}</textarea></label>
      <div class="grid" style="align-items:end">
        <div><label>Tags (comma-separated)<input data-k="tags" value="${(it.tags||[]).join(', ')}"/></label></div>
        <div>
          <label>Upload images<input type="file" data-k="upload" multiple accept="image/*"/></label>
          <button class="btn secondary" data-act="ok">OK</button>
          <button class="btn secondary" data-act="del" style="float:right">Delete</button>
        </div>
      </div>`;
    // bind
    div.addEventListener('input',e=>{
      const k=e.target.dataset.k; if(!k)return;
      if(k==='tags'){ it.tags = e.target.value.split(',').map(s=>s.trim()).filter(Boolean); }
      else{ it[k]=e.target.value; }
    });
    div.addEventListener('click',e=>{
      const act=e.target.dataset.act; if(!act) return;
      if(act==='del'){ state.research.splice(idx,1); render(); }
      if(act==='ok'){
        const inp=div.querySelector('[data-k="upload"]');
        if(!inp || !inp.files.length) return alert('Choose file(s) first');
        const paths=[];
        for(const f of Array.from(inp.files)){
          const p='assets/'+fileSafe(f.name); state._uploads[p]=f; paths.push(p);
        }
        // put first image if empty; append others to desc (optional) or ignore
        if(!it.img && paths.length) it.img=paths[0];
        inp.value='';
        render();
      }
    });
    els.researchList.appendChild(div);
  });

  els.pubList.innerHTML='';
  state.publications.forEach((p,idx)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class="grid">
        <div><label>Title<input data-k="title" value="${p.title||''}"/></label></div>
        <div><label>Meta (authors • venue • year)<input data-k="meta" value="${p.meta||''}"/></label></div>
      </div>
      <div class="grid" style="align-items:end">
        <div><label>Link (DOI/URL)<input data-k="link" value="${p.link||''}"/></label></div>
        <div><button class="btn secondary" data-act="del" style="margin-top:24px">Delete</button></div>
      </div>`;
    div.addEventListener('input',e=>{ const k=e.target.dataset.k; if(k) p[k]=e.target.value; });
    div.addEventListener('click',e=>{ if(e.target.dataset.act==='del'){ state.publications.splice(idx,1); render(); }});
    els.pubList.appendChild(div);
  });

  els.skillList.innerHTML='';
  state.skills.forEach((s,idx)=>{
    const div=document.createElement('div'); div.className='card';
    div.innerHTML=`
      <div class="grid" style="align-items:end">
        <div><label>Title<input data-k="title" value="${s.title||''}"/></label></div>
        <div><button class="btn secondary" data-act="del">Delete</button></div>
      </div>
      <label>Text<textarea data-k="text">${s.text||''}</textarea></label>`;
    div.addEventListener('input',e=>{ const k=e.target.dataset.k; if(k) s[k]=e.target.value; });
    div.addEventListener('click',e=>{ if(e.target.dataset.act==='del'){ state.skills.splice(idx,1); render(); }});
    els.skillList.appendChild(div);
  });

  // tops
  els.site_title.value = state.site.title||'';
  els.resume_url.value = state.site.resume||'';
  els.hero_lead.value = state.site.hero.lead||'';
  els.hero_img.value  = state.site.hero.img||'';
  els.hero_location.value = state.site.hero.location||'';
  els.about_text.value = state.about.text||'';
  els.contact_email.value = state.contact.email||'';
  els.contact_location.value = state.contact.location||'';
  els.contact_socials.value = (state.contact.socials||[]).join(', ');
}
render();

// add buttons
els.addResearch.onclick = ()=>{ state.research.push({title:'New research',desc:'',img:'',tags:[]}); render(); };
els.addPub.onclick = ()=>{ state.publications.push({title:'Paper title',meta:'Authors • Venue • Year',link:''}); render(); };
els.addSkill.onclick = ()=>{ state.skills.push({title:'Skill area',text:'Short description'}); render(); };

// hero upload
els.hero_img_ok.onclick = ()=>{
  const f=els.hero_img_upload.files[0]; if(!f) return alert('Choose a file first');
  const path='assets/'+fileSafe(f.name); state._uploads[path]=f; state.site.hero.img=path; els.hero_img.value=path; els.hero_img_upload.value=''; render();
};

// bind simple inputs
['input','change'].forEach(ev=>{
  els.site_title.addEventListener(ev, ()=>state.site.title=els.site_title.value);
  els.resume_url.addEventListener(ev, ()=>state.site.resume=els.resume_url.value);
  els.hero_lead.addEventListener(ev, ()=>state.site.hero.lead=els.hero_lead.value);
  els.hero_img.addEventListener(ev,  ()=>state.site.hero.img=els.hero_img.value);
  els.hero_location.addEventListener(ev, ()=>state.site.hero.location=els.hero_location.value);
  els.about_text.addEventListener(ev, ()=>state.about.text=els.about_text.value);
  els.contact_email.addEventListener(ev, ()=>state.contact.email=els.contact_email.value);
  els.contact_location.addEventListener(ev, ()=>state.contact.location=els.contact_location.value);
  els.contact_socials.addEventListener(ev, ()=>state.contact.socials = els.contact_socials.value.split(',').map(s=>s.trim()).filter(Boolean));
});

// draft
$('#saveDraft').onclick = ()=>{
  localStorage.setItem('pf_editor_draft', JSON.stringify({...state,_uploads:{}}));
  alert('Saved draft on this device.');
};
const rawDraft=localStorage.getItem('pf_editor_draft'); if(rawDraft){ try{ Object.assign(state, JSON.parse(rawDraft)); state._uploads={}; render(); }catch{} }

// load data.json
$('#loadJson').onclick = async ()=>{
  try{
    const r=await fetch('data.json?cache='+Date.now()); const d=await r.json();
    Object.assign(state, d); state._uploads={}; render(); alert('Loaded data.json');
  }catch(e){ alert('Could not load data.json'); }
};

// remember github creds
$('#remember').onclick = ()=>{
  const repo = $('#repo').value.trim().replace(/^https?:\/\/github\.com\//i,'').replace(/\/?$/,'');
  localStorage.setItem('pf_editor_creds', JSON.stringify({repo, branch:$('#branch').value||'main', root:$('#rootPath').value||'', token:$('#token').value}));
  alert('Saved GitHub settings.');
};
$('#forget').onclick = ()=>{ localStorage.removeItem('pf_editor_creds'); $('#token').value=''; alert('Cleared.'); };
const savedCreds = localStorage.getItem('pf_editor_creds'); if(savedCreds){ const c=JSON.parse(savedCreds); $('#repo').value=c.repo||''; $('#branch').value=c.branch||'main'; $('#rootPath').value=c.root||''; $('#token').value=c.token||''; }

// publish
function b64(s){return btoa(unescape(encodeURIComponent(s))); }
function b64Bytes(u8){let s=''; for(let i=0;i<u8.length;i++) s+=String.fromCharCode(u8[i]); return btoa(s);}
async function gatherFiles(){
  const files=[];
  const clean = {...state}; delete clean._uploads;
  files.push({path:'data.json', content:b64(JSON.stringify(clean,null,2))});
  for(const [p,f] of Object.entries(state._uploads||{})){
    if(f && typeof f.arrayBuffer==='function'){
      const arr=new Uint8Array(await f.arrayBuffer());
      files.push({path:p, content:b64Bytes(arr)});
    }
  }
  return files;
}
$('#publish').onclick = async ()=>{
  try{
    setStatus('Publishing…');
    const repoFull = $('#repo').value.trim().replace(/^https?:\/\/github\.com\//i,'').replace(/\/?$/,'');
    const [owner,repo] = repoFull.split('/');
    const branch = ($('#branch').value||'main').trim();
    const token  = $('#token').value.trim();
    const root   = $('#rootPath').value.trim();
    if(!owner||!repo||!token){ alert('Set repo and token first'); setStatus(''); return; }
    const base = `https://api.github.com/repos/${owner}/${repo}/contents/`;
    const files=await gatherFiles();
    for(const f of files){
      const path = (root? (root.replace(/\/?$/,'/')+f.path):f.path);
      let sha; try{
        const meta=await fetch(base+encodeURIComponent(path)+`?ref=${encodeURIComponent(branch)}`,{headers:{Authorization:`Bearer ${token}`}});
        if(meta.status===200){ const j=await meta.json(); sha=j.sha; }
      }catch{}
      const res=await fetch(base+encodeURIComponent(path),{
        method:'PUT',
        headers:{'Authorization':`Bearer ${token}`,'Content-Type':'application/json'},
        body:JSON.stringify({message:`chore: update ${f.path} via portfolio editor`, content:f.content, branch, sha})
      });
      if(!res.ok){ const t=await res.text(); alert('Failed on '+path+'\n'+t); setStatus('Publish failed'); return; }
    }
    state._uploads={};
    setStatus('Published ✓');
    alert('Published! GitHub Pages will refresh shortly.');
  }catch(e){ console.error(e); setStatus('Publish failed'); }
};
</script>
</body>
</html>
